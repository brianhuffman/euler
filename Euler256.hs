module Euler256 where
import Primes

{---------------------------------------------------------------------
Problem 256
Tatami-Free Rooms

19 September 2009

Tatami are rectangular mats, used to completely cover the floor of a
room, without overlap.

Assuming that the only type of available tatami has dimensions 1×2,
there are obviously some limitations for the shape and size of the
rooms that can be covered.

For this problem, we consider only rectangular rooms with integer
dimensions a, b and even size s = a·b.

We use the term 'size' to denote the floor surface area of the room,
and — without loss of generality — we add the condition a ≤ b.

There is one rule to follow when laying out tatami: there must be no
points where corners of four different mats meet.

For example, consider the two arrangements below for a 4×4 room:

        +-------+-------+       +-------+---+---+
        |       |       |       |       |   |   |
        +---+---+---+---+       +-------+   |   |
        |   |       |   |       |       |   |   |
        |   +-------+   |       +---+---X---+---+
        |   |       |   |       |   |   |       |
        +---+---+---+---+       |   |   +-------+
        |       |       |       |   |   |       |
        +-------+-------+       +---+---+-------+

The arrangement on the left is acceptable, whereas the one on the
right is not: a red "X" in the middle, marks the point where four
tatami meet.

Because of this rule, certain even-sized rooms cannot be covered with
tatami: we call them tatami-free rooms.

Further, we define T(s) as the number of tatami-free rooms of size s.

The smallest tatami-free room has size s = 70 and dimensions 7×10.
All the other rooms of size s = 70 can be covered with tatami; they
are: 1×70, 2×35 and 5×14.  Hence, T(70) = 1.

Similarly, we can verify that T(1320) = 5 because there are exactly 5
tatami-free rooms of size s = 1320: 20×66, 22×60, 24×55, 30×44 and
33×40.

In fact, s = 1320 is the smallest room-size s for which T(s) = 5.

Find the smallest room-size s for which T(s) = 200.

---------------------------------------------------------------------}


{---------------------------------------------------------------------

Four nearly-square patterns:

2n x 2n
+-------+-------+
|       |       |
+---+---+---+---+
|   |       |   |
|   +-------+   |
|   |       |   |
+---+---+---+---+
|       |       |
+-------+-------+

2n x 2n+1
+-------+-------+---+
|       |       |   |
+---+---+---+---+   |
|   |       |   |   |
|   +-------+   +---+
|   |       |   |   |
+---+---+---+---+   |
|       |       |   |
+-------+-------+---+

2n x 2n+2
+---+-------+-------+---+
|   |       |       |   |
|   +---+---+---+---+   |
|   |   |       |   |   |
+---+   +-------+   +---+
|   |   |       |   |   |
|   +---+---+---+---+   |
|   |       |       |   |
+---+-------+-------+---+

2n+1 x 2n+2
+-------+-------+-------+
|       |       |       |
+---+---+---+---+---+---+
|   |       |       |   |
|   +---+---+---+---+   |
|   |   |       |   |   |
+---+   +-------+   +---+
|   |   |       |   |   |
|   +---+---+---+---+   |
|   |       |       |   |
+---+-------+-------+---+

----------------------------------------------------------------------

Five repeated patterns:

2n x k(2n+1)-1    (for k=1, this becomes 2n x 2n)
+-------+-------+---+-------+-------+---+-------+-------+
|       |       |   |       |       |   |       |       |
+---+---+---+---+   +---+---+---+---+   +---+---+---+---+
|   |       |   |   |   |       |   |   |   |       |   |
|   +-------+   +---+   +-------+   +---+   +-------+   |
|   |       |   |   |   |       |   |   |   |       |   |
+---+---+---+---+   +---+---+---+---+   +---+---+---+---+
|       |       |   |       |       |   |       |       |
+-------+-------+---+-------+-------+---+-------+-------+

2n x k(2n+1)      (for k=1, this becomes 2n x 2n+1)
+---+-------+-------+---+-------+-------+---+-------+-------+
|   |       |       |   |       |       |   |       |       |
|   +---+---+---+---+   +---+---+---+---+   +---+---+---+---+
|   |   |       |   |   |   |       |   |   |   |       |   |
+---+   +-------+   +---+   +-------+   +---+   +-------+   |
|   |   |       |   |   |   |       |   |   |   |       |   |
|   +---+---+---+---+   +---+---+---+---+   +---+---+---+---+
|   |       |       |   |       |       |   |       |       |
+---+-------+-------+---+-------+-------+---+-------+-------+

2n x k(2n+1)+1    (for k=1, this becomes 2n x 2n+2)
+---+-------+-------+---+-------+-------+---+-------+-------+---+
|   |       |       |   |       |       |   |       |       |   |
|   +---+---+---+---+   +---+---+---+---+   +---+---+---+---+   |
|   |   |       |   |   |   |       |   |   |   |       |   |   |
+---+   +-------+   +---+   +-------+   +---+   +-------+   +---+
|   |   |       |   |   |   |       |   |   |   |       |   |   |
|   +---+---+---+---+   +---+---+---+---+   +---+---+---+---+   |
|   |       |       |   |       |       |   |       |       |   |
+---+-------+-------+---+-------+-------+---+-------+-------+---+

2n+1 x k(2n+2)    (for k=1, this becomes 2n+1 x 2n+2)
+-------+-------+---+-------+---+-------+-------+---+-------+---+
|       |       |   |       |   |       |       |   |       |   |
+---+---+---+---+   +-------+   +---+---+---+---+   +-------+   |
|   |       |   |   |       |   |   |       |   |   |       |   |
|   +-------+   +---+---+---+---+   +-------+   +---+---+---+---+
|   |       |   |       |       |   |       |   |       |       |
+---+-------+---+-------+-------+---+-------+---+-------+-------+

2n+1 x k(2n)      (for k=1, this becomes 2n x 2n+1 - reoriented)
+-------+-------+---+-------+---+-------+-------+---+-------+---+
|       |       |   |       |   |       |       |   |       |   |
+---+---+---+---+   +---+---+   +---+---+---+---+   +---+---+   |
|   |       |   |   |   |   |   |   |       |   |   |   |   |   |
|   +---+---+   +---+   |   +---+   +---+---+   +---+   |   +---+
|   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |   |
+---+   |   +---+   +---+---+   +---+   |   +---+   +---+---+   |
|   |   |   |   |   |       |   |   |   |   |   |   |       |   |
|   +---+---+   +---+---+---+---+   +---+---+   +---+---+---+---+
|   |       |   |       |       |   |       |   |       |       |
+---+-------+---+-------+-------+---+-------+---+-------+-------+

----------------------------------------------------------------------

Quasi-periodic patterns:

2n x k(2n+1)+j(2n-1)
+-------+-------+---+-------+-------+---+-------+---+-------+---+
|       |       |   |       |       |   |       |   |       |   |
+---+---+---+---+   +---+---+---+---+   +---+---+   +---+---+   |
|   |       |   |   |   |       |   |   |   |   |   |   |   |   |
|   +-------+   +---+   +-------+   +---+   |   +---+   |   +---+
|   |       |   |   |   |       |   |   |   |   |   |   |   |   |
+---+---+---+---+   +---+---+---+---+   +---+---+   +---+---+   |
|       |       |   |       |       |   |       |   |       |   |
+-------+-------+---+-------+-------+---+-------+---+-------+---+

2n x k(2n+1)+j(2n-1)-1
+-------+-------+---+-------+-------+---+-------+---+-------+
|       |       |   |       |       |   |       |   |       |
+---+---+---+---+   +---+---+---+---+   +---+---+   +---+---+
|   |       |   |   |   |       |   |   |   |   |   |   |   |
|   +-------+   +---+   +-------+   +---+   |   +---+   |   |
|   |       |   |   |   |       |   |   |   |   |   |   |   |
+---+---+---+---+   +---+---+---+---+   +---+---+   +---+---+
|       |       |   |       |       |   |       |   |       |
+-------+-------+---+-------+-------+---+-------+---+-------+

2n x k(2n+1)+j(2n-1)+1
+---+-------+-------+---+-------+-------+---+-------+---+-------+---+
|   |       |       |   |       |       |   |       |   |       |   |
|   +---+---+---+---+   +---+---+---+---+   +---+---+   +---+---+   |
|   |   |       |   |   |   |       |   |   |   |   |   |   |   |   |
+---+   +-------+   +---+   +-------+   +---+   |   +---+   |   +---+
|   |   |       |   |   |   |       |   |   |   |   |   |   |   |   |
|   +---+---+---+---+   +---+---+---+---+   +---+---+   +---+---+   |
|   |       |       |   |       |       |   |       |   |       |   |
+---+-------+-------+---+-------+-------+---+-------+---+-------+---+

2n+1 x k(2n)+j(2n+2)
+-------+---+---+-------+---+---+-------+-------+---+-------+---+
|       |   |   |       |   |   |       |       |   |       |   |
+---+---+   |   +---+---+   |   +---+---+---+---+   +-------+   |
|   |   |   |   |   |   |   |   |   |       |   |   |       |   |
|   +   +---+---+   +   +---+---+   +-------+   +---+---+---+---+
|   |   |       |   |   |       |   |       |   |       |       |
+---+---+-------+---+---+-------+---+-------+---+-------+-------+

----------------------------------------------------------------------

If the short side is even, we have a range of possibilities:

2n x k(2n+1)+j(2n-1)
2n x k(2n+1)+j(2n-1)-1
2n x k(2n+1)+j(2n-1)+1

2n x (j+k)(2n) + (k-j) + [-1,0,1]

For j+k=m, all b from m(a-1)-1 to m(a+1)+1 will work.

a\m| 1      2      3      4      5
---+--------------------------------
 2 | -4    1-7    2-10   3-13   4-16
 4 | -6    5-11   8-16  11-21  14-26
 6 | -8    9-15  14-22  19-29  24-36
 8 | -10~~13-19  20-28  27-37  34-46
10 | -12~~17-23~~26-34  35-45  44-56
12 | -14~~21-27~~32-40~~43-53  54-66
14 | -16~~25-31~~38-46~~51-61~~64-76

Tatami-free sizes:
 8x11-12
10x13-16, 10x24-25
12x15-20, 12x28-31, 12x41-42
14x17-24, 14x32-37, 14x47-50, 14x62-63
...

Size (2n x b) always has a tatami if 2n^2-5n < b.
Let (q,r) = (b-2) `divMod` (a+1) in a < 2*q+r+5.

----------------------------------------------------------------------

If the short side is odd, we have a range of possibilities:

2n+1 x k(2n)+j(2n+2)

For j+k=m, all even b from m(a-1) to m(a+1) will work.

a\m| 1      2      3      4      5
---+--------------------------------
 3 | -4    4-8    6-12   8-16  10-20
 5 | -6    8-12  12-18  16-24  20-30
 7 | -8~~~12-16  18-24  24-32  30-40
 9 | -10~~16-20~~24-30  32-40  40-50
11 | -12~~20-24~~30-36~~40-48  50-60
13 | -14~~24-28~~36-42~~48-56~~60-70

Tatami-free sizes:
 7x10
 9x12-14,  9x22
11x14-18, 11x26-28, 11x38
13x16-22, 13x30-34, 13x44-46, 13x58
15x18-26, 15x34-40, 15x50-54, 15x66-68, 15x82

Size (2n+1 x b) always has a tatami if 2n^2-2n-2 < b.
Let (q,r) = (b-2) `divMod` (a+1) in a < 2*q+r+5.

---------------------------------------------------------------------}

-- precondition: even (a*b)
tatami_free (a, b)
  | b < a  = tatami_free (b, a)
  | otherwise = let (q,r) = (b-2) `divMod` (a+1) in 2*q+r+4 < a

room_size s = length (filter tatami_free ds')
  where
    ds = [ (a, b) | a <- list_divisors s, let b = s `div` a ]
    ds' = takeWhile (\(a,b) -> a < b) ds

value_of_pf pf = product [ p^e | (p, e) <- pf ]

room_size_pf pf = length (filter tatami_free ds')
  where
    s = value_of_pf pf
    ds = [ (a, b) | a <- list_divisors_of_pf pf, let b = s `div` a ]
    ds' = takeWhile (\(a,b) -> a < b) ds

prob256 n = head
  [ s | s <- list_divisors z,
    even s, num_divisors s > 2*n, room_size s == n ]
  where z = 2^10*3^8*5^6*7^5*11^4*13^3*17^2*19*23*29
-- TODO: more principled way to do the search
-- We need an algorithm to give a stream of numbers with many divisors

{-
smallest room sizes
T(s) = 1: 70           2 5 7                          (8 divisors)
T(s) = 2: 198          2 3 3 11                       (12 divisors)
T(s) = 3: 336          2 2 2 2 3 7                    (20 divisors)
T(s) = 4: 504          2 2 2 3 3 7                    (24 divisors)
T(s) = 5: 1320         2 2 2 3 5 11                   (32 divisors)
T(s) = 6: 1440         2 2 2 2 2 3 3 5                (36 divisors)
T(s) = 7: 3696         2 2 2 2 3 7 11                 (40 divisors)
T(s) = 8: 3360         2 2 2 2 2 3 5 7                (48 divisors)
T(s) = 9: 5040         2 2 2 2 3 3 5 7                (60 divisors)
T(s) = 10: 8400        2 2 2 2 3 5 5 7                (60 divisors)
T(s) = 20: 30240       2 2 2 2 2 3 3 3 5 7            (96 divisors)
T(s) = 30: 151200      2 2 2 2 2 3 3 3 5 5 7          (144 divisors)
T(s) = 40: 327600      2 2 2 2 3 3 5 5 7 13           (180 divisors)
T(s) = 50: 554400      2 2 2 2 2 3 3 5 5 7 11         (216 divisors)
T(s) = 60: 720720      2 2 2 2 3 3 5 7 11 13          (240 divisors)
T(s) = 70: 2550240     2 2 2 2 2 3 3 5 7 11 23        (288 divisors)
T(s) = 80: 2494800     2 2 2 2 3 3 3 3 5 5 7 11       (300 divisors)
T(s) = 90: 5266800     2 2 2 2 3 3 5 5 7 11 19        (360 divisors)
T(s) = 100: 6683040    2 2 2 2 2 3 3 3 5 7 13 17      (384 divisors)
T(s) = 110: 11309760   2 2 2 2 2 2 3 3 3 5 7 11 17    (448 divisors)
T(s) = 120: 19459440   2 2 2 2 3 3 3 3 3 5 7 11 13    (480 divisors)
T(s) = 140: 49884120   2 2 2 3 3 3 5 11 13 17 19      (512 divisors)
T(s) = 160: 45945900   2 2 3 3 3 5 5 7 11 13 17       (576 divisors)
T(s) = 180: 60540480   2 2 2 2 2 2 3 3 3 5 7 7 11 13  (672 divisors)
T(s) = 200: 85765680   2 2 2 2 3 3 5 7 7 11 13 17     (720 divisors)

-}

main :: IO String
main = return $ show $ prob256 200

answer :: String
answer = "85765680"
