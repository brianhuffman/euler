module Euler127 where
import PrimeArray (multiplicative_array)
import Primes (prime_factorization)
import EulerLib (sortOf, thd3)
import Data.Array.Unboxed

{-
Problem 127
01 September 2006

The radical of n, rad(n), is the product of distinct prime factors of
n. For example, 504 = 2^(3) × 3^(2) × 7, so rad(504) = 2 × 3 × 7 = 42.

We shall define the triplet of positive integers (a, b, c) to be an
abc-hit if:

   1. GCD(a, b) = GCD(a, c) = GCD(b, c) = 1
   2. a < b
   3. a + b = c
   4. rad(abc) < c

For example, (5, 27, 32) is an abc-hit, because:

   1. GCD(5, 27) = GCD(5, 32) = GCD(27, 32) = 1
   2. 5 < 27
   3. 5 + 27 = 32
   4. rad(4320) = 30 < 32

It turns out that abc-hits are quite rare and there are only
thirty-one abc-hits for c < 1000, with ∑c = 12523.

Find ∑c for c < 110000.

-}


{-
Analysis:

GCD(a, a+b) = GCD(a,b)
GCD(b, a+b) = GCD(a,b)
So if any two are coprime, that is sufficient to satisfy rule (1).

The radical function is multiplicative:
For relatively prime a,b, radical(a*b) = radical(a)*radical(b)

Also, radical(a) | a.

radical(a*b*c) < c
radical(a*b*(a+b)) < a+b
radical(a) * radical(b) * radical(a+b) < a+b
radical(a) * radical(b) < (a+b) `div` radical(a+b)
-}

radical_array :: Int -> UArray Int Int
radical_array = multiplicative_array f
  where f (p,e) = p

radical :: Int -> Int
radical n = product $ map fst $ prime_factorization n

abc_hits :: Int -> [(Int, Int, Int)]
abc_hits m =
  [ (a, b, c) |
    c <- xs,
    let k = c `div` (r!c), -- this always divides exactly
    a <- takeWhile (\a -> r!a <= k) ys,
    a <= c`div`2,
    gcd a c == 1,
    let b = c - a,
    r!a * r!b < k -- with m = 110000, this just fits in 32 bits.
  ]
  where
    r :: UArray Int Int
    r = radical_array m
    xs = 1 : filter (\b -> r!b < b) [2 .. m]
    ys = sortOf (r!) [1 .. m]

prob127 :: Int -> Int
prob127 m = sum $ map thd3 $ abc_hits m

main :: IO String
main = return $ show $ prob127 110000

answer :: String
answer = "15377700"


{-
[(1,8,9),(5,27,32),(1,48,49),(1,63,64),(1,80,81),(32,49,81),(4,121,125),(3,125,128),(1,224,225),(1,242,243),(2,243,245),(7,243,250),(81,175,256),(13,243,256),(1,288,289),(100,243,343),(32,343,375),(5,507,512),(169,343,512),(1,512,513),(27,512,539),(1,624,625),(81,544,625),(49,576,625),(1,675,676),(1,728,729),(25,704,729),(200,529,729),(104,625,729),(1,960,961),(343,625,968),(1,1024,1025),(5,1024,1029),(1,1215,1216),(8,1323,1331),(81,1250,1331),(243,1088,1331),(640,729,1369),(256,1331,1587),(81,1600,1681),(243,1805,2048),(25,2023,2048),(23,2025,2048),(9,2048,2057),(512,1675,2187),(11,2176,2187),(139,2048,2187),(81,2116,2197),(10,2187,2197),(1,2303,2304),(125,2187,2312),(1,2400,2401),(1024,1377,2401),(25,2376,2401),(192,2209,2401),(99,2401,2500),(625,2048,2673),(1,3024,3025),(875,2197,3072),(128,2997,3125),(53,3072,3125),(11,3125,3136),(1024,2187,3211),(25,3456,3481),(459,3125,3584),(128,3645,3773),(648,3125,3773),(1,3887,3888),(1,3968,3969),(512,3481,3993),(7,3993,4000),(1,4095,4096),(125,3971,4096),(375,3721,4096),(11,4096,4107),(35,4096,4131),(256,3969,4225),(2048,2187,4235),(1,4374,4375),(49,4864,4913),(128,4913,5041),(17,5103,5120),(2187,3125,5312),(1331,4096,5427),(7,5625,5632),(2401,3375,5776),(1,5831,5832),(19,6125,6144),(9,6241,6250),(1,6399,6400),(1,6560,6561),(1024,5537,6561),(2401,4160,6561),(320,6241,6561),(289,6272,6561),(961,5600,6561),(2209,4352,6561),(161,6400,6561),(64,6561,6625),(64,6591,6655),(1,6655,6656),(784,6075,6859),(1,6859,6860),(16,6859,6875),(53,6859,6912),(1183,6561,7744),(3087,4913,8000),(19,8000,8019),(9,8183,8192),(11,8181,8192),(1,8575,8576),(343,8405,8748),(16,9245,9261),(1125,8192,9317),(1183,8192,9375),(1,9375,9376),(1,9408,9409),(1,9800,9801),(25,9801,9826),(3125,6859,9984),(2197,7803,10000),(1,10647,10648),(1331,9604,10935),(41,10935,10976),(4096,6889,10985),(9,10976,10985),(2401,9375,11776),(32,11875,11907),(5120,6859,11979),(27,12005,12032),(125,11907,12032),(162,12005,12167),(17,12150,12167),(1,12167,12168),(121,12167,12288),(512,11881,12393),(2401,10368,12769),(1,14336,14337),(16,14625,14641),(49,14592,14641),(4913,9728,14641),(529,14112,14641),(1681,12960,14641),(1519,13122,14641),(98,14641,14739),(243,14641,14884),(4,15125,15129),(2809,12500,15309),(1,15624,15625),(16,15609,15625),(4096,11529,15625),(9,15616,15625),(729,14896,15625),(162,15463,15625),(19,15606,15625),(1701,13924,15625),(1936,13689,15625),(1369,14256,15625),(5041,10584,15625),(73,15552,15625),(137,15488,15625),(984,14641,15625),(6877,8748,15625),(8,15625,15633),(1,16128,16129),(9,16375,16384),(49,16335,16384),(3159,13225,16384),(2209,14175,16384),(1075,15309,16384),(759,15625,16384),(9,16384,16393),(2000,14641,16641),(8192,8575,16767),(40,16767,16807),(8019,8788,16807),(2166,14641,16807),(423,16384,16807),(3,16807,16810),(68,16807,16875),(491,16384,16875),(121,16807,16928),(1536,15625,17161),(3125,14283,17408),(5329,12167,17496),(729,16807,17536),(1,17576,17577),(49,18176,18225),(3584,14641,18225),(4913,13312,18225),(1875,16384,18259),(1625,16807,18432),(2187,16384,18571),(2401,16384,18785),(81,19375,19456),(20,19663,19683),(31,19652,19683),(83,19600,19683),(475,19208,19683),(29,19683,19712),(64,19683,19747),(121,19652,19773),(125,19683,19808),(317,19683,20000),(243,20237,20480),(128,20449,20577),(289,20736,21025),(16,21125,21141),(4489,16807,21296),(23,21609,21632),(243,21632,21875),(1,21951,21952),(32,24025,24057),(7,24057,24064),(1,24299,24300),(11,24565,24576),(2401,22599,25000),(1,25920,25921),(6728,19683,26411),(8192,19683,27875),(256,27869,28125),(1,28125,28126),(6561,22000,28561),(49,28512,28561),(1125,27436,28561),(5,28561,28566),(16,28561,28577),(32,28561,28593),(111,28561,28672),(1,29375,29376),(13778,15625,29403),(10108,19683,29791),(1,29791,29792),(13122,16807,29929),(13568,16807,30375),(6561,24064,30625),(351,30625,30976),(14297,16807,31104),(1,31212,31213),(2209,29791,32000),(125,32643,32768),(7,32761,32768),(8379,24389,32768),(1,32768,32769),(37,32768,32805),(15625,17303,32928),(507,32768,33275),(125,33489,33614),(1,33614,33615),(32,34263,34295),(16,34375,34391),(128,34263,34391),(1875,32768,34643),(23,34969,34992),(15625,20096,35721),(3721,32000,35721),(25,35912,35937),(6561,29791,36352),(8303,28561,36864),(11,36864,36875),(1024,39601,40625),(7857,32768,40625),(847,40625,41472),(31,41472,41503),(14641,26912,41553),(243,42632,42875),(2048,41875,43923),(19,43904,43923),(11449,32768,44217),(20736,24389,45125),(16384,29241,45625),(11552,34375,45927),(6859,39366,46225),(4913,41743,46656),(1,49247,49248),(729,49000,49729),(1,50175,50176),(125,50176,50301),(2048,48373,50421),(1,50624,50625),(896,49729,50625),(28,50625,50653),(1875,48778,50653),(22528,28125,50653),(232,50421,50653),(19683,31250,50933),(1331,50653,51984),(10985,41503,52488),(2197,50625,52822),(2704,50421,53125),(637,52488,53125),(7168,46875,54043),(16384,38291,54675),(6912,48013,54925),(1,55296,55297),(3125,52441,55566),(4913,50653,55566),(19683,36125,55808),(1,57121,57122),(1,58563,58564),(1,59048,59049),(4,59045,59049),(15625,43424,59049),(49,59000,59049),(10000,49049,59049),(169,58880,59049),(968,58081,59049),(15488,43561,59049),(13924,45125,59049),(485,58564,59049),(1,59049,59050),(119,59049,59168),(128,59049,59177),(4096,55223,59319),(56,59319,59375),(343,59049,59392),(1,59535,59536),(4,60021,60025),(1944,58081,60025),(121,59904,60025),(976,59049,60025),(19683,40817,60500),(1960,59049,61009),(14641,46875,61516),(49,61952,62001),(2048,60025,62073),(125,62083,62208),(49,62451,62500),(1,63000,63001),(9,64000,64009),(15625,48384,64009),(2875,61952,64827),(1,65024,65025),(3,65533,65536),(7,65529,65536),(169,65367,65536),(23,65513,65536),(7569,57967,65536),(317,65219,65536),(10611,54925,65536),(709,64827,65536),(6487,59049,65536),(89,65536,65625),(513,65536,66049),(7000,59049,66049),(2048,64827,66875),(625,66603,67228),(1,68607,68608),(800,68121,68921),(49,69120,69169),(3,69629,69632),(6859,63125,69984),(10609,59375,69984),(2,70225,70227),(1,71874,71875),(13312,59049,72361),(243,72962,73205),(15625,58806,74431),(31104,44521,75625),(361,75264,75625),(1,76544,76545),(17,77824,77841),(36864,41261,78125),(9261,68864,78125),(29282,48843,78125),(841,77284,78125),(29791,48334,78125),(507,77618,78125),(14256,63869,78125),(2349,75776,78125),(284,77841,78125),(301,77824,78125),(38759,39366,78125),(16,78125,78141),(121,78125,78246),(243,78125,78368),(607,78125,78732),(625,78608,79233),(4096,75411,79507),(775,78732,79507),(81,79919,80000),(4913,75087,80000),(2401,78732,81133),(22201,59049,81250),(729,81191,81920),(1,82943,82944),(1,83520,83521),(1152,82369,83521),(2401,81120,83521),(172,83349,83521),(25921,57600,83521),(577,82944,83521),(8192,75843,84035),(2401,81920,84321),(6561,78608,85169),(15,85169,85184),(31250,54043,85293),(7168,78125,85293),(512,85293,85805),(2500,83349,85849),(729,87079,87808),(19683,68125,87808),(14641,73167,87808),(85,87723,87808),(2125,85683,87808),(16384,71825,88209),(1681,86528,88209),(729,89383,90112),(6591,83521,90112),(1,90624,90625),(32768,58357,91125),(11,91125,91136),(35,93312,93347),(8192,85849,94041),(16807,78125,94932),(1,97199,97200),(16807,81608,98415),(729,99127,99856),(19,99981,100000),(1,101250,101251),(1331,100000,101331),(529,101871,102400),(87,102400,102487),(5408,98415,103823),(625,103823,104448),(1,105624,105625),(2673,103823,106496),(1,107648,107649),(5,107648,107653),(128,109375,109503)]
-}